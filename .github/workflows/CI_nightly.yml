name: Nightly

on:
  schedule:
    - cron: "*/10 * * * *"   # Ejecutar cada 10 minutos (solo para pruebas)
  workflow_dispatch:

concurrency:
  group: nightly
  cancel-in-progress: true

permissions:
  contents: read
  issues: write

jobs:

  quality:
    name: Quality (Lint + Tests)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Lint (flake8 + black + isort)
        run: |
          pip install flake8 black isort
          flake8 .
          black --check .
          isort --check-only .

      - name: Run Pytest
        env:
          PYTHONUNBUFFERED: 1
        run: |
          pip install pytest
          pytest -q


  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install auditing tools
        run: pip install pip-audit

      - name: Scan Python dependencies
        run: |
          pip install -r requirements.txt
          pip-audit --progress-spinner off


  notify:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [quality, security]

    if: ${{ needs.quality.result == 'failure' || needs.security.result == 'failure' }}

    permissions:
      issues: write
      contents: read

    steps:

      - name: Build failure summary
        id: summary
        run: |
          echo "quality_result=${{ needs.quality.result }}" >> $GITHUB_OUTPUT
          echo "security_result=${{ needs.security.result }}" >> $GITHUB_OUTPUT

          FAIL_MSG=""

          if [ "${{ needs.quality.result }}" = "failure" ]; then
            FAIL_MSG="${FAIL_MSG}- *Quality (Lint/Tests) ha fallado*\n"
          fi

          if [ "${{ needs.security.result }}" = "failure" ]; then
            FAIL_MSG="${FAIL_MSG}- *Security Scan ha fallado*\n"
          fi

          echo "fail_message<<EOF" >> $GITHUB_OUTPUT
          echo -e "$FAIL_MSG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Issue
        uses: actions/github-script@v7
        with:
          script: |
            const failMsg = `${{ steps.summary.outputs.fail_message }}`;

            const body = `
### Nightly FAILED

**Fecha:** ${new Date().toISOString()}

**Problemas detectados:**
${failMsg}

---

### üìé Enlace al run:
${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}

Revisa los logs para m√°s detalles.
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Nightly FAILED - ${new Date().toISOString().slice(0,10)}`,
              body: body
            });

      - name: Send email notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_HOST }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASS }}

          from: "Nightly Bot <${{ secrets.SMTP_USER }}>"
          subject: "‚ùå Nightly FAILED en ${{ github.repository }}"

          to: |
            correo1@example.com
            correo2@example.com
            correo3@example.com

          body: |
            ‚ùå Nightly FAILED en ${{ github.repository }}

            Problemas detectados:

            ${{ steps.summary.outputs.fail_message }}

            Enlace al run:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            Revisa logs para m√°s informaci√≥n.
