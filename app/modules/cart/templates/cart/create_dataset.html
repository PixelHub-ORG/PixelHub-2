{% extends "base_template.html" %}

{% block title %}Create dataset{% endblock %}

{% block content %}

     <div class="row">

        <div class="col-xl-6 col-lg-12 col-md-12 col-sm-12">
            <div id="basic_info_form">

                {{ form.hidden_tag() }}

                <div class="row">

                    <div class="col-12">

                        <h1 class="h3 mb-3">Basic info</h1>

                        <div class="row" style="padding-left: 2rem">

                            <div class="col-lg-6 col-xs-12 col-md-12">
                                <div class="mb-3">
                                    {{ form.title.label(class="form-label") }} *
                                    {{ form.title(class="form-control") }}
                                    {% for error in form.title.errors %}
                                        <span style="color: red;">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="col-12">
                                <div class="mb-3">
                                    {{ form.desc.label(class="form-label") }} *
                                    {{ form.desc(rows=4, class="form-control") }}
                                    {% for error in form.desc.errors %}
                                        <span style="color: red;">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="col-lg-6 col-6">
                                <div class="mb-3">
                                    {{ form.publication_type.label(class="form-label") }}
                                    {{ form.publication_type(class="form-control") }}
                                </div>

                            </div>

                            <div class="col-lg-6 col-6">
                                <div class="mb-3">
                                    {{ form.publication_doi.label(class="form-label") }}
                                    {{ form.publication_doi(class="form-control") }}
                                    {% for error in form.publication_doi.errors %}
                                        <span style="color: red;">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="col-6">
                                <div class="mb-3">
                                    {{ form.tags.label(class="form-label") }}
                                    {{ form.tags(class="form-control") }}
                                    {% for error in form.tags.errors %}
                                        <span style="color: red;">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>

                        </div>

                        <h1 class="h3 mb-3 mt-4">
                          Authors
                          <a href="#" data-toggle="modal" data-target="#infoModal">
                            <i data-feather="info"></i> <!-- Usamos "info" porque Feather no tiene un ícono específico llamado "feather" para más info -->
                          </a>
                        </h1>

                        <!-- Modal -->
                        <div class="modal fade" id="infoModal" tabindex="-1" role="dialog" aria-labelledby="infoModalLabel" aria-hidden="true" style="display: none">
                          <div class="modal-dialog" role="document">
                            <div class="modal-content">
                              <div class="modal-header">
                                <h5 class="modal-title" id="infoModalLabel">Información Importante</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                  <span aria-hidden="true">&times;</span>
                                </button>
                              </div>
                              <div class="modal-body">
                                ¡Cuidado! Los autores no se pueden editar una vez que el dataset se haya subido a UVLHub. Esta funcionalidad estará disponible para futuras versiones.
                              </div>
                              <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                              </div>
                            </div>
                          </div>
                        </div>

                        <div class="row" style="padding-left: 2rem">

                            <div class="col-lg-6 col-12 mb-3">
                                <label class="form-label">Author name</label>
                                <input class="form-control"
                                       disabled
                                       value="{{ current_user.profile.surname }}, {{ current_user.profile.name }}">
                            </div>

                            <div class="col-lg-6 col-12 mb-3">
                                <label class="form-label">Author affiliation</label>
                                <input class="form-control"
                                       disabled value="{{ current_user.profile.affiliation }}">
                            </div>

                            <div class="col-lg-6 col-12 mb-3">
                                <label class="form-label">Author ORCID</label>
                                <input class="form-control"
                                       disabled value="{{ current_user.profile.orcid }}">
                            </div>

                            <div class="col-12">

                                <div class="mb-3">

                                    <div id="authors">
                                        {% for subform in form.authors %}
                                        <div class="row author" {% if not loop.first %}
                                            style="border:2px dotted #ccc;border-radius:10px;padding:10px;margin:10px 0; background-color: white"
                                            {% endif %}
                                        >
                                            <div class="col-lg-6 col-12 mb-3">
                                                {{ subform.form.name.label(class="form-label") }}
                                                {{ subform.form.name(class="form-control", disabled=loop.first) }}
                                                {% for error in subform.name.errors %}
                                                    <span style="color: red;">{{ error }}</span>
                                                {% endfor %}
                                            </div>

                                            <div class="col-lg-6 col-12 mb-3">
                                                {{ subform.form.affiliation.label(class="form-label") }}
                                                {{ subform.form.affiliation(class="form-control", disabled=loop.first) }}
                                                {% for error in subform.name.errors %}
                                                    <span style="color: red;">{{ error }}</span>
                                                {% endfor %}
                                            </div>

                                            <div class="col-lg-6 col-12 mb-3">
                                                {{ subform.orcid.label(class="form-label") }}
                                                {{ subform.orcid(class="form-control", disabled=loop.first) }}
                                                {% for error in subform.orcid.errors %}
                                                    <span style="color: red;">{{ error }}</span>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    <button type="button" class="btn btn-secondary" id="add_author">Add author
                                    </button>

                                </div>

                            </div>


                        </div>

                    </div>

                </div>

                <div class="row">

                    {% if error %}

                        <div class="mt-3 col-lg-6 col-12">
                            <span style="color: red;">{{ error }}</span>
                        </div>

                    {% endif %}

                </div>


            </div>
        </div>

        <div class="col-xl-6 col-lg-12 col-md-12 col-sm-12">

            <h1 class="h3 mb-3 mt-2">Cart</h1>

            <div class="col-xl-6 col-lg-12 col-md-12 col-sm-12">

    {% if models %}
    <div id="cart-list">
        {% for model in models %}
        <div class="card mb-3 shadow-sm">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    
                    <div>
                        <h5 class="mb-0"><b>{{ model.name }}</b></h5>
                        <p class="text-muted small mb-1">{{ model.description|truncate(80) }}</p>
                        <p class="small mb-0">
                            Authors: 
                            {% for author in model.authors %}
                                {{ author.name }}{% if not loop.last %}, {% endif %}
                            {% endfor %}
                        </p>
                    </div>
                    
                    <button 
                        class="btn btn-sm btn-outline-danger" 
                        onclick="deleteCartItem('{{ model.id }}')" 
                        title="Remove from cart"
                    >
                        <i data-feather="trash-2" style="width: 16px; height: 16px;"></i>
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="mt-3 text-end">
        <a href="{{ url_for('cart.create_dataset') }}" class="btn btn-primary">
            <i data-feather="plus-square"></i> Create Dataset
        </a>
    </div>

    {% else %}
    <div class="alert alert-info" role="alert">
        Your cart is empty. Add some models to get started!
    </div>
    {% endif %}

{% endblock %}

{% block scripts %}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
        feather.replace();
        });

        function deleteCartItem(modelID) {
        fetch("/user/cart/delete", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ item_id: modelID })
        })
        .then(async response => {
            const data = await response.json(); 
            alert("File removed from cart."); 
            if (response.ok) {
                location.reload();
            }
        })
        .catch(err => console.error("Error deleting from cart:", err));
        }
    </script>
{% endblock %}